# セキュリティ

## セキュリティ対策

このプロジェクトでは、以下のセキュリティ対策を実施しています。

### 1. CORS (Cross-Origin Resource Sharing) の設定

- デフォルトで制限的なCORS設定を使用
- 環境変数 `CORS_ORIGINS` で許可するオリジンを明示的に指定
- 本番環境では必ず適切なオリジンを設定してください

```bash
CORS_ORIGINS=https://yourdomain.com,https://www.yourdomain.com
```

### 2. 管理API の認証

- `/api/admin/*` エンドポイントは認証が必要
- 環境変数 `ADMIN_API_KEY` でAPIキーを設定
- リクエスト時に `X-API-Key` ヘッダーでAPIキーを送信

```bash
# 環境変数の設定
ADMIN_API_KEY=your-secure-api-key-here

# APIの使用例
curl -X POST https://api.example.com/api/admin/sync \
  -H "X-API-Key: your-secure-api-key-here"
```

### 3. パストラバーサル対策

- ZIPファイルの展開時に、パストラバーサル攻撃を防ぐための検証を実施
- 全てのファイルパスが展開先ディレクトリ内に収まることを確認

### 4. 入力検証

- 郵便番号、都道府県コード、市区町村コードなどの入力を厳格に検証
- Azure Functions APIでは、検索クエリの入力をサニタイズして、インジェクション攻撃を防止
- 日本語文字、英数字、一般的な句読点のみを許可

### 5. 依存関係の管理

- 定期的に依存関係の脆弱性をチェック
- 既知の脆弱性がある依存パッケージは速やかに更新

## セキュリティ脆弱性の報告

セキュリティ脆弱性を発見した場合は、以下の手順で報告してください：

1. **公開のIssueは作成しないでください**
2. プロジェクトメンテナーに直接連絡してください
3. 脆弱性の詳細、再現手順、影響範囲を記載してください

## セキュリティのベストプラクティス

### 本番環境での推奨設定

1. **環境変数の設定**
   ```bash
   # 必須: データベース接続文字列
   DATABASE_URL=postgresql://user:password@host:5432/dbname
   
   # 必須: 管理APIキー (強力なランダムな文字列を使用)
   ADMIN_API_KEY=your-very-strong-random-api-key
   
   # 必須: CORS許可オリジン (実際のドメインに置き換え)
   CORS_ORIGINS=https://yourdomain.com
   ```

2. **データベースのセキュリティ**
   - 強力なパスワードを使用
   - データベースへのアクセスを必要最小限に制限
   - SSL/TLS接続を有効化

3. **Azure Functions の設定** (Azure Functions使用時)
   - HTTPS のみを許可
   - Azure Key Vault でシークレットを管理
   - Application Insights でログとメトリクスを監視

4. **定期的なセキュリティ更新**
   - 依存パッケージを定期的に更新
   - セキュリティパッチを速やかに適用

## セキュリティチェックリスト

デプロイ前に以下を確認してください：

- [ ] `ADMIN_API_KEY` が設定され、強力なパスワードが使用されている
- [ ] `CORS_ORIGINS` が適切なドメインに制限されている
- [ ] データベース接続が SSL/TLS で暗号化されている
- [ ] すべての依存パッケージが最新の安全なバージョンである
- [ ] 本番環境で `DEBUG=False` に設定されている
- [ ] ログに機密情報が含まれていないことを確認
- [ ] バックアップが定期的に実行されている

## 監査ログ

管理操作（データ同期など）は自動的にログに記録されます。定期的にログを確認し、不正なアクセスがないか監視してください。
