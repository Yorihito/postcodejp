# 脆弱性レビューレポート

**レビュー日**: 2026-01-31
**リポジトリ**: Yorihito/postcodejp
**レビュー実施者**: GitHub Copilot

## エグゼクティブサマリー

PostcodeJP リポジトリの包括的なセキュリティレビューを実施し、以下の脆弱性を特定して修正しました：

- **重大度: 高** - 1件
- **重大度: 中** - 3件
- **重大度: 低** - 2件

すべての脆弱性が修正され、CodeQLスキャンでも追加の問題は検出されませんでした。

## 発見された脆弱性と修正内容

### 1. CORS設定の過度な許可 (重大度: 中)

**問題点**:
- `app/main.py` で `allow_origins=["*"]` と設定されており、すべてのオリジンからのアクセスを許可
- クロスサイトリクエストフォージェリ (CSRF) 攻撃のリスクが高まる

**影響範囲**:
- FastAPI アプリケーション全体
- すべてのAPIエンドポイント

**修正内容**:
```python
# 修正前
allow_origins=["*"]

# 修正後
allowed_origins = settings.cors_origins.split(",") if settings.cors_origins else ["https://postcodejp.ddns.net"]
allow_origins=allowed_origins
```

**推奨事項**:
- 本番環境では必ず `CORS_ORIGINS` 環境変数を設定
- 信頼できるドメインのみを許可リストに追加

---

### 2. Admin API の認証なし (重大度: 高)

**問題点**:
- `/api/admin/sync` エンドポイントが認証なしで公開
- 誰でもデータ同期処理を実行可能
- サービス妨害 (DoS) やリソース枯渇攻撃のリスク

**影響範囲**:
- `/api/admin/*` すべてのエンドポイント
- データ同期処理の不正実行

**修正内容**:
1. APIキー認証の実装
```python
def verify_admin_key(x_api_key: str = Header(None)):
    if not settings.require_admin_auth:
        return
    
    if not settings.admin_api_key:
        raise HTTPException(status_code=500, detail="Admin API key not configured")
    
    if not x_api_key or x_api_key != settings.admin_api_key:
        raise HTTPException(status_code=401, detail="Unauthorized")
    return x_api_key
```

2. 環境変数の追加
   - `ADMIN_API_KEY`: APIキー
   - `REQUIRE_ADMIN_AUTH`: 認証の要否（デフォルト: True）

**推奨事項**:
- 本番環境では必ず `ADMIN_API_KEY` を設定
- 強力なランダムな文字列を使用（32文字以上推奨）
- `REQUIRE_ADMIN_AUTH=True` に設定

---

### 3. Path Traversal 脆弱性 (重大度: 中)

**問題点**:
- `app/services/downloader.py` で `zipfile.extractall()` を使用
- 悪意のあるZIPファイルでシステム外のファイルを上書き可能
- 任意のファイル書き込み攻撃のリスク

**影響範囲**:
- データダウンロード・展開処理
- 日本郵便のデータファイル処理

**修正内容**:
```python
def extract_zip(self, zip_path: Path) -> Optional[Path]:
    with zipfile.ZipFile(zip_path, "r") as zf:
        # ファイルパスの検証を追加
        for member in zf.namelist():
            member_path = (extract_dir / member).resolve()
            if not str(member_path).startswith(str(extract_dir.resolve())):
                raise ValueError(f"Unsafe file path: {member}")
        
        zf.extractall(extract_dir)
```

**推奨事項**:
- 信頼できないソースからのZIPファイルは慎重に処理
- ファイル展開前に常にパスを検証

---

### 4. 入力検証の不足 (重大度: 中)

**問題点**:
- Azure Functions API の検索クエリで十分な入力検証がない
- OData フィルタークエリの構築時にインジェクションのリスク
- シングルクォートのエスケープのみで不十分

**影響範囲**:
- `/api/postal-codes/search` エンドポイント
- Azure Table Storage のクエリ処理

**修正内容**:
```typescript
// サニタイゼーション関数の追加
const ALLOWED_SEARCH_PATTERN = /[^\p{L}\p{N}\u3000-\u303f\u3040-\u309f\u30a0-\u30ff\uff00-\uff9f\u4e00-\u9faf\u3400-\u4dbf\s\-]/gu;

function sanitizeSearchTerm(term: string): string {
    return term.replace(ALLOWED_SEARCH_PATTERN, '');
}

// 使用例
const sanitizedTerms = terms.map(term => sanitizeSearchTerm(term));
```

**推奨事項**:
- すべてのユーザー入力を検証・サニタイズ
- ホワイトリスト方式で許可文字を限定

---

### 5. 依存関係の脆弱性 (重大度: 低)

**問題点**:
- FastAPI 0.109.0 に ReDoS (Regular Expression Denial of Service) 脆弱性
- CVE記載: Content-Type Header ReDoS

**影響範囲**:
- FastAPI アプリケーション全体
- HTTP リクエスト処理

**修正内容**:
```
# requirements.txt
fastapi>=0.109.0  →  fastapi>=0.115.0
```

**推奨事項**:
- 依存パッケージを定期的に更新
- GitHub Dependabot を有効化して自動アラートを受信

---

### 6. CORS ヘッダーの不足 (重大度: 低)

**問題点**:
- `X-API-Key` ヘッダーが CORS 許可リストに含まれていない
- Admin API のクロスオリジン呼び出しが失敗する可能性

**影響範囲**:
- Admin API のクロスオリジンアクセス

**修正内容**:
```python
allow_headers=["Content-Type", "Authorization", "X-API-Key"]
```

---

## セキュリティスキャン結果

### CodeQL 静的解析
- **Python**: 脆弱性なし (0 alerts)
- **JavaScript/TypeScript**: 脆弱性なし (0 alerts)

### 依存関係スキャン
- FastAPI の脆弱性を検出・修正
- その他の依存パッケージは安全

## 追加の推奨事項

### 短期 (即実装推奨)

1. **環境変数の設定**
   - すべての本番環境で `ADMIN_API_KEY` と `CORS_ORIGINS` を設定
   - `.env` ファイルをバージョン管理から除外（既に除外済み）

2. **セキュリティヘッダーの追加**
   - `X-Content-Type-Options: nosniff`
   - `X-Frame-Options: DENY`
   - `Strict-Transport-Security: max-age=31536000`

3. **レート制限の実装**
   - API エンドポイントにレート制限を追加
   - 特に Admin API と検索エンドポイント

### 中期 (3ヶ月以内)

1. **ログとモニタリング**
   - セキュリティイベントのログ記録
   - 不正アクセス試行の検知

2. **自動セキュリティスキャン**
   - CI/CD パイプラインに CodeQL を統合
   - Dependabot による依存関係の自動更新

3. **API キーのローテーション**
   - 定期的な API キーの更新プロセス
   - 複数の API キーのサポート

### 長期 (6ヶ月以内)

1. **OAuth2/JWT 認証への移行**
   - より堅牢な認証メカニズム
   - トークンベースの認証

2. **WAF (Web Application Firewall) の導入**
   - Azure Application Gateway または類似のサービス
   - DDoS 対策と追加のセキュリティレイヤー

3. **ペネトレーションテスト**
   - 専門業者による脆弱性診断
   - 定期的なセキュリティ監査

## まとめ

本レビューにより、PostcodeJP リポジトリの主要なセキュリティ脆弱性はすべて修正されました。実装されたセキュリティ対策：

✅ CORS 設定の厳格化
✅ Admin API の認証実装
✅ Path Traversal 対策
✅ 入力検証の強化
✅ 依存関係の脆弱性修正
✅ セキュリティドキュメントの整備

これらの修正により、アプリケーションのセキュリティ態勢が大幅に向上しました。今後は、本レポートの推奨事項に従い、継続的なセキュリティ改善を実施してください。
